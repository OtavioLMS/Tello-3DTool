<html>

<head>
    <title>Tello 3D Tool</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            color: #33ff33;
            z-index: 1;
        }

    </style>
</head>

<body>
    <canvas id="myCanvas"></canvas>

    <script src="js/three.js"></script>
    <script src="js/tello.js"></script>
    <script src="js/controls/DragControls.js"></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="js/controls/TransformControls.js"></script>
    <script>
        var cor = 0xA44400;
        
        var positions = new Array();
        
        var tello = new Tello(document.getElementById('myCanvas'));
        var controls = new THREE.OrbitControls(tello.camera);
        
        
        var transformControl = new THREE.TransformControls(tello.camera, tello.renderer.domElement);
        transformControl.addEventListener('change', function(){tello.render});
        transformControl.addEventListener('dragging-changed', function (event) {
            controls.enabled = ! event.value;
        });
        tello.scene.add(transformControl);
        transformControl.addEventListener('change', function () {
            cancelHideTransform();
        });
        transformControl.addEventListener('mouseDown', function () {
            cancelHideTransform();
        });
        transformControl.addEventListener('mouseUp', function () {
            delayHideTransform();
        });
        
        var objs = [];
        objs.push(tello.droneFrames[0]);
        
        var dragcontrols = new THREE.DragControls(objs, tello.camera, tello.renderer.domElement );
        dragcontrols.enabled = false;
        dragcontrols.addEventListener('hoveron', function(event){
            transformControl.attach(event.object);
            cancelHideTransform();
        });
        dragcontrols.addEventListener('hoveroff', function(){
            delayHideTransform();
        });
        var hiding;
        function delayHideTransform(){
            cancelHideTransform();
            hideTransform();
        }
        function hideTransform(){
            hiding = setTimeout(function(){
                transformControl.detach(transformControl.object);
            }, 2500);
        }
        function cancelHideTransform(){
            if (hiding) clearTimeout(hiding);
        }
        
        render();
        
        function render() {
            controls.update();
            updateControls();
            tello.desenharPercurso();
            tello.renderer.render(tello.scene, tello.camera);
            requestAnimationFrame(render);
        };
        
        document.onkeydown = function(e) {
            console.log(e.keyCode);
            switch (e.keyCode) {
                case 88: // X - ADICIONAR POSIÇÃO
                    if(tello.droneFrames.length == 1){
                        tello.setPositionFrame(cor);
                        positions.push(tello.droneMesh.position);
                    } else if(tello.droneFrames[tello.droneFrames.length - 1].position.y <= 1 && tello.droneMesh.position.y <= 1){
                        tello.droneMesh.position.y = 10;
                        tello.setPositionFrame(cor);
                        positions.push(tello.droneMesh.position);
                    } else {
                        tello.setPositionFrame(cor);
                        positions.push(tello.droneMesh.position);
                    }
                    cor += 5;
                    break;
                case 82: // R - MODO ROTATE
                    if(tello.droneFrames.length > 1){
                        transformControl.showX = false;
                        transformControl.showY = true;
                        transformControl.showZ = false;
                        transformControl.setMode('rotate');
                    }
                    break;
                case 69: // E - MODO TRANSLATE
                    updateControls();
                    transformControl.setMode('translate');
                    break;
                case 46: // DELETE - DELETAR POSIÇÃO
                    if(tello.droneFrames.length >= 2){
                        tello.deletePositionFrame();
                        positions.pop();
                    }
                    if(tello.droneFrames.length == 1){
                        tello.droneMesh.position.y = 1;
                    }
                    break;
                case 67: // C - CENTRALIZAR
                    tello.droneMesh.position.x = 0;
                    tello.droneMesh.position.z = 0;
                    tello.droneMesh.rotation.y = 0;
                    break;
                case 76: // L - LIMPAR
                    tello.deleteAllFrames();
                    positions = [];
                    tello.droneMesh.position.y = 1;
                    tello.droneMesh.position.x = 0;
                    tello.droneMesh.position.z = 0;
                    tello.droneMesh.rotation.y = 0;
                    break;
            }
        };
        
        
        
        window.addEventListener('resize', onWindowResize, false);
        
        function onWindowResize() {
            tello.camera.aspect = window.innerWidth / window.innerHeight;
            tello.camera.updateProjectionMatrix();
            tello.renderer.setSize( window.innerWidth, window.innerHeight );
        }
        
        function updateControls(){
            if(positions.length == 0){
                transformControl.showY = false;
            } else {
                if(transformControl.getMode() == 'translate'){
                    transformControl.showX = true;
                    transformControl.showY = true;
                    transformControl.showZ = true;
                } else if(transformControl.getMode() == 'rotate'){
                    transformControl.showX = false;
                    transformControl.showY = true;
                    transformControl.showZ = false;
                }
            }
            if(tello.droneMesh.position.y <= 0.5){
                tello.droneMesh.position.y = 1;
            }
            if(tello.droneMesh.position.y >= 40){
                tello.droneMesh.position.y = 39;
            }
            if(tello.droneMesh.position.x <= -50){
                tello.droneMesh.position.x = -49;
            }
            if(tello.droneMesh.position.x >= 50){
                tello.droneMesh.position.x = 49;
            }
            if(tello.droneMesh.position.z <= -50){
                tello.droneMesh.position.z = -49;
            }
            if(tello.droneMesh.position.z >= 50){
                tello.droneMesh.position.z = 49;
            }
        }
        
    </script>
</body>

</html>
